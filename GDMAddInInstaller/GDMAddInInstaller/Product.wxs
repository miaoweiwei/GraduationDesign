<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="*" Name="毕业设计信息管理系统" Language="2052" Codepage="936" Version="1.1.1" Manufacturer="MiaoWeiWei" UpgradeCode="9823c1c7-c057-4740-b50e-0de583c32f16">

    <!--<WixLocalization Codepage="utf-8" Culture="fr-ca" xmlns="http://schemas.microsoft.com/wix/2006/localization"></WixLocalization>-->
    <!--需要管理员注册的时候Package中 InstallPrivileges="elevated" -->
    <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Languages="2052" InstallPrivileges="elevated" ShortNames ="yes"/>

    <MajorUpgrade DowngradeErrorMessage="一个新版本的[ProductName]已经安装，您安装的不是最新版本" />
    <MediaTemplate EmbedCab="yes" />

    <!--定义规定的安装目录-->
    <!--<Property Id ="ADDINFOLDER" Value="C:\Sumscope\Quoteboard\AddIn\"/>-->
    <!--<Property Id ="AddinFolder" Value="C:\Sumscope\Quoteboard\AddIn\"/>-->
    <!--指定安装在那个磁盘-->
    <Property Id ="AddinSourceDir" Value="C:\"/>
    <!--保存Excel位数-->
    <Property Id="OFFICEBITNESS" Secure="yes"/>

    <!--检测 安装时Excel是否关闭使用的属性变量-->
    <Property Id="PromptToCloseProcesses" Value="EXCEL" />
    <Property Id="PromptToCloseDisplayNames" Value="Microsoft Excel" />

    <!--Excel版本号、xll文件名属性-->
    <Property Id="OFFICEREGKEYS" Value="12.0,14.0,15.0,16.0" />
    <Property Id="XLL32" Value="GraduationDesignManagement-AddIn-packed.xll" />
    <Property Id="XLL64" Value="GraduationDesignManagement-AddIn64-packed.xll" />

    <!--安装窗口-->
    <!--ADDINFOLDER为选定的安装目录-->
    <!--所选目录,ADDINFOLDER就是所选目录,名称唯一就行,但是必须大写,否则就会安装在所有磁盘的最后一盘里-->
    <Property Id="WIXUI_INSTALLDIR" Value="ADDINFOLDER" />
    <UIRef Id="WixUI_InstallDir" />
    <!--<UIRef Id="WixUI_Minimal" />-->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf"  />

    <Feature Id="ProductFeature" Title="SumscopeAddInDeploy" Level="1">
      <ComponentGroupRef Id="x86_ProductComponents" />
      <ComponentGroupRef Id="x64_ProductComponents" />
      <ComponentGroupRef Id="Pics_ProductComponents" />
      <ComponentGroupRef Id="Config_ProductComponents"/>
      <!--<ComponentGroupRef Id="FolderRemove"/>-->
    </Feature>

    <!--检测 .NET Framework-->
    <PropertyRef Id="NETFRAMEWORK40FULL" />
    <Condition Message="检测到您的电脑未安装.NET Framework 4.0，请安装后重试.您可以到https://download.microsoft.com/download/9/5/A/95A9616B-7A37-4AF6-BC36-D6EA96C8DAAE/dotNetFx40_Full_x86_x64.exe下载">
      <![CDATA[NETFRAMEWORK40FULL]]>
    </Condition>

    <!--检测 支持的Excel是否安装-->
    <Property Id="EXCEL2007INSTALLPATH" Secure="yes">
      <RegistrySearch Id="OfficeExcel2007InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\12.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <RegistrySearch Id="OfficeExcel2007InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\12.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Property Id="EXCEL2010INSTALLPATH" Secure="yes">
      <RegistrySearch Id="OfficeExcel2010InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <RegistrySearch Id="OfficeExcel2010InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Property Id="EXCEL2013INSTALLPATH" Secure="yes">
      <RegistrySearch Id="OfficeExcel2013InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <RegistrySearch Id="OfficeExcel2013InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Property Id="EXCEL2016INSTALLPATH" Secure="yes">
      <RegistrySearch Id="OfficeExcel2016InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\16.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <RegistrySearch Id="OfficeExcel2016InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\16.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Condition Message="此插件仅支持Office Excel 2007 and/or 2010 and/or 2013 and/or 2016 (32-bit or 64-bit)，检测到您未安装相对应的版本，请安装后重试">
      <![CDATA[Installed OR EXCEL2007INSTALLPATH OR EXCEL2010INSTALLPATH OR EXCEL2013INSTALLPATH OR EXCEL2016INSTALLPATH]]>
    </Condition>

    <!--<Condition Message="[OfficeExcel2007InstallPath64]">OFFICEBITNESS=1</Condition>-->

    <!--Custom Action-->
    <!--如果是要让Action 用管理员的身份去执行：Impersonate="no"-->
    
    <Binary Id="InstallerCA.CA.dll" SourceFile="$(var.InstallerCA.TargetDir)$(var.InstallerCA.TargetName).CA.dll" />

    <!--<CustomAction Id="Action_Olduninstall" BinaryKey="InstallerCA.CA.dll" DllEntry="CaOldUninstall" Return="check" />-->
    <CustomAction Id="Action_RegisterAddIn" BinaryKey="InstallerCA.CA.dll" DllEntry="CaRegisterAddIn" Return="check" Execute="immediate" />
    <CustomAction Id="Action_UnRegisterAddIn" BinaryKey="InstallerCA.CA.dll" DllEntry="CaUnRegisterAddIn" Return="check" Execute="immediate"  />
    <CustomAction Id="Action_CloseAppsPrompt" BinaryKey="InstallerCA.CA.dll" DllEntry="ClosePrompt" Return="check" />

    <CustomAction Id="Action_CheckExcelBitness" BinaryKey="InstallerCA.CA.dll" DllEntry="CacheckExcelBitness" Return="check" Execute="immediate" />

    <InstallExecuteSequence>
      <Custom Action="Action_CloseAppsPrompt" Before="CostInitialize"></Custom>
      <!--<Custom Action="Action_Olduninstall" After="Action_CloseAppsPrompt">NOT REINSTALL</Custom>-->
      <Custom Action="Action_CheckExcelBitness" After="Action_CloseAppsPrompt">NOT Installed</Custom>
      <Custom Action="Action_UnRegisterAddIn" After="Action_CheckExcelBitness"></Custom>

      <Custom Action="Action_RegisterAddIn" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>

    <AdminExecuteSequence>
      <Custom Action="Action_CloseAppsPrompt" Before="CostInitialize"></Custom>
      <!--<Custom Action="Action_Olduninstall" After="Action_CloseAppsPrompt">NOT REINSTALL</Custom>-->
      <Custom Action="Action_CheckExcelBitness" After="Action_CloseAppsPrompt">NOT Installed</Custom>
      <Custom Action="Action_UnRegisterAddIn" After="Action_CheckExcelBitness"></Custom>

      <Custom Action="Action_RegisterAddIn" After="InstallFiles">NOT Installed</Custom>
    </AdminExecuteSequence>

  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="GraduationDesignManagementSystem">
          <Directory Id="ADDINFOLDER">
            <Directory Id="Resources" Name="Resources"/>
            <Directory Id="Config" Name="Config"/>
          </Directory>
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <!--x86文件资源-->
  <Fragment>
    <ComponentGroup Id="x86_ProductComponents" >
      <Component Id="x86_AddFiles" Directory="ADDINFOLDER" Guid="{5372D475-88B2-46F0-BA3B-16DE7F89022C}">
        <!--x86 AddIn文件 12 项-->
        <Condition>OFFICEBITNESS="x86"</Condition>

        <File Id ="x86_GraduationDesignManagement.dll" Source="x86\GraduationDesignManagement.dll"/>
        <File Id ="x86_GraduationDesignManagement.dll.config" Source="x86\GraduationDesignManagement.dll.config"/>
        <File Id ="x86_GraduationDesignManagement.pdb" Source="x86\GraduationDesignManagement.pdb"/>
        <File Id ="x86_GraduationDesignManagement_AddIn.dna" Source="x86\GraduationDesignManagement-AddIn.dna"/>
        <File Id ="x86_GraduationDesignManagement_AddIn.xll" Source="x86\GraduationDesignManagement-AddIn.xll"/>
        <File Id ="x86_GraduationDesignManagement_AddIn_packed.xll" Source="x86\GraduationDesignManagement-AddIn-packed.xll"/>
        
        <File Id ="x86_ICSharpCode.SharpZipLib.dll" Source="x86\ICSharpCode.SharpZipLib.dll"/>
        <File Id ="x86_log4net.dll" Source="x86\log4net.dll"/> 
        <File Id ="x86_log4net.xml" Source="x86\log4net.xml"/> 
        <File Id ="x86_MySql.Data.dll" Source="x86\MySql.Data.dll"/>
        <File Id ="x86_Newtonsoft.Json.dll" Source="x86\Newtonsoft.Json.dll"/>
        <File Id ="x86_Newtonsoft.Json.xml" Source="x86\Newtonsoft.Json.xml"/>
      </Component>
    </ComponentGroup>
  </Fragment>

  <!--x64文件资源-->
  <Fragment>
    <ComponentGroup Id="x64_ProductComponents" >
      <Component Id="x64_AddFiles" Directory="ADDINFOLDER" Guid="{A4889405-39BE-42DC-BAA0-DCCBFA57A73A}">
        <!--x64 AddIn文件 12 项-->
        <Condition>OFFICEBITNESS="x64"</Condition>
        <File Id ="x64_GraduationDesignManagement.dll" Source="x64\GraduationDesignManagement.dll"/>
        <File Id ="x64_GraduationDesignManagement.dll.config" Source="x64\GraduationDesignManagement.dll.config"/>
        <File Id ="x64_GraduationDesignManagement.pdb" Source="x64\GraduationDesignManagement.pdb"/>
        <File Id ="x64_GraduationDesignManagement_AddIn64.dna" Source="x64\GraduationDesignManagement-AddIn64.dna"/>
        <File Id ="x64_GraduationDesignManagement_AddIn64.xll" Source="x64\GraduationDesignManagement-AddIn64.xll"/>
        <File Id ="x64_GraduationDesignManagement_AddIn64_packed.xll" Source="x64\GraduationDesignManagement-AddIn64-packed.xll"/>
        <File Id ="x64_ICSharpCode.SharpZipLib.dll" Source="x64\ICSharpCode.SharpZipLib.dll"/>
        <File Id ="x64_log4net.dll" Source="x64\log4net.dll"/>
        <File Id ="x64_log4net.xml" Source="x64\log4net.xml"/>
        <File Id ="x64_MySql.Data.dll" Source="x64\MySql.Data.dll"/>
        <File Id ="x64_Newtonsoft.Json.dll" Source="x64\Newtonsoft.Json.dll"/>
        <File Id ="x64_Newtonsoft.Json.xml" Source="x64\Newtonsoft.Json.xml"/>
      </Component>
    </ComponentGroup>
  </Fragment>

  <!--图片资源文件，该资源x86、x64都需要使用，不用区分，统一从x86文件夹中获取-->
  <Fragment>
    <ComponentGroup Id="Pics_ProductComponents" >
      <Component Id="Pics" Directory="Resources" Guid="{9B36A3D5-9857-4AF5-8189-B00B4DD8E88F}" >
        <!--图片资源 16项-->
        <File Id ="about.png" Source="x86\Resources\about.png"/>
        <File Id ="chooseTearch.png" Source="x86\Resources\chooseTearch.png"/>
        <File Id ="filebox.png" Source="x86\Resources\filebox.png"/>
        <File Id ="fixproject.png" Source="x86\Resources\fixproject.png"/>
        <File Id ="getschedule.png" Source="x86\Resources\getschedule.png"/>
        <File Id ="login.png" Source="x86\Resources\login.png" />
        <File Id ="logout.png" Source="x86\Resources\logout.png" />
        <File Id ="mystudent.png" Source="x86\Resources\mystudent.png" />
        <File Id ="openfile.png" Source="x86\Resources\openfile.png"/>
        <File Id ="project.png" Source="x86\Resources\project.png"/>
        <File Id ="reply.png" Source="x86\Resources\reply.png"/>
        <File Id ="replyGroup.png" Source="x86\Resources\replyGroup.png"/>
        <File Id ="score.png" Source="x86\Resources\score.png"/>
        <File Id ="setschedule.png" Source="x86\Resources\setschedule.png"/>
        <File Id ="snake.png" Source="x86\Resources\snake.png"/>
        <File Id ="student.png" Source="x86\Resources\student.png"/>
      </Component>
    </ComponentGroup>
  </Fragment>

  <!--Xml文件,该资源x86、x64都需要使用，不用区分，统一从x86文件夹中获取-->
  <Fragment>
    <ComponentGroup Id="Config_ProductComponents">
      <Component Id="Xml_File" Directory="Config" Guid="{BD5B7D3E-B003-4D72-9148-F66AE59BE0F6}">
        <File Id ="x86_App.config" Source="x86\Config\App.config"/>
      </Component>
    </ComponentGroup>
  </Fragment>

</Wix>
